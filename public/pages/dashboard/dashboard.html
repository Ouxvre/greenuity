<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Greenuity - Dashboard</title>

    <!-- tailwindcss -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- google font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              poppins: ["Poppins", "sans-serif"],
            },
            colors: {
              primary: "#1B4D57",
              "primary-light": "#2D6670",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-50 font-poppins">
    <!-- Header -->
    <div
      class="relative bg-[#0E3B43] text-white p-6 pb-24 rounded-b-3xl flex justify-between items-start"
    >
      <!-- Left Side -->
      <div class="space-y-3 mt-5">
        <!-- Location -->
        <div
          class="flex items-center gap-1.5 bg-white/10 text-white/80 px-2.5 py-1.5 rounded-full text-xs w-fit"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.2"
            stroke="currentColor"
            class="w-4 h-4"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"
            />
          </svg>
          <span id="userLocation">Tanjung Uban, Indonesia</span>
        </div>

        <!-- Greeting -->
        <div>
          <h2 class="text-lg mt-10">
            Hello, <span id="userName" class="font-semibold">Loading User....</span>
          </h2>
          <p id="currentDate" class="text-sm text-white/70">
            Kamis, 25 Dec 2025
          </p>
        </div>
      </div>

      <!-- Right Side -->
      <div class="flex gap-3 mt-5">
        <!-- Notification -->
        <button
          class="w-10 h-10 bg-white/10 rounded-full hover:bg-white/20 transition duration-200 flex items-center justify-center mt-1"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 17h5l-1.405-1.405M19 13V8a7 7 0 10-14 0v5l-1.405 1.405A2.032 2.032 0 003 18h18a2.032 2.032 0 00-.595-1.595L19 13z"
            />
          </svg>
        </button>

        <!-- Profile -->
        <img
          id="profileImage"
          src="../../assets/foto-default.jpeg"
          class="w-11 h-11 rounded-full object-cover border-2 border-white/30"
        />
      </div>
    </div>

    <!-- Overlap Card -->
    <div class="relative z-10 px-6">
      <div class="bg-white rounded-3xl shadow-md -mt-14 p-6 min-h-[300px]">
        <h3 class="text-gray-800 font-semibold text-lg mb-3">
          Informasi Sistem
        </h3>
        <p id="weatherInfo" class="text-gray-600 text-sm mb-3">
          Memuat data suhu...
        </p>
      </div>
    </div>

    <!-- Main Content -->
    <div class="px-6 py-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Device</h2>

      <!-- Device List -->
      <div class="space-y-3" id="deviceList"></div>
    </div>

    <!-- Bottom Navigation - Floating -->
    <div class="fixed bottom-4 left-4 right-4 z-50">
      <div class="bg-white rounded-3xl shadow-2xl px-6 py-4">
        <div class="flex items-center justify-around">
          <!-- BERANDA (aktif / primary) -->
          <button
            onclick="goToHome()"
            class="flex flex-col items-center space-y-1 text-primary"
          >
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M10.707 1.293a1 1 0 00-1.414 0l-8 8a1 1 0 001.414 1.414L3 10.414V17a1 1 0 001 1h3a1 1 0 001-1v-4h2v4a1 1 0 001 1h3a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-8-8z"
              />
            </svg>
            <span class="text-xs font-semibold">Beranda</span>
          </button>

          <button
            onclick="goToMonitoring()"
            class="flex flex-col items-center space-y-1 text-gray-600"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
            <span class="text-xs">Monitoring</span>
          </button>

          <button
            onclick="goToIrrigation()"
            class="flex flex-col items-center space-y-1 text-gray-600"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
              />
            </svg>
            <span class="text-xs">Irigasi</span>
          </button>

          <button
            onclick="goToEducation()"
            class="flex flex-col items-center space-y-1 text-gray-600"
          >
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              />
            </svg>
            <span class="text-xs">Edukasi</span>
          </button>

          <!-- PROFIL (non-aktif / abu) -->
          <button
            onclick="goToProfile()"
            class="flex flex-col items-center space-y-1 text-gray-600"
          >
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="text-xs">Profil</span>
          </button>
        </div>
      </div>
    </div>
  </body>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script src="/../js/config/firebase-config.js"></script>

  <script>
    // Navigation functions
    function goToHome() {
      window.location.href = `../dashboard/dashboard.html`;
    }

    function goToMonitoring() {
      window.location.href = "../monitoring/monitoring.html";
    }

    function goToAddDevice() {
      window.location.href = "add-device.html";
    }

    function goToIrrigation() {
      window.location.href = "irrigation.html";
    }

    function goToProfile() {
      window.location.href = "../profile/profile.html";
    }

    // tanggal
    const dateEl = document.getElementById("currentDate");
    const now = new Date();
    const options = {
      weekday: "long",
      day: "2-digit",
      month: "short",
      year: "numeric",
    };
    dateEl.textContent = now.toLocaleDateString("id-ID", options);

    //Ambil nama user dari Firebase Auth
    firebase.auth().onAuthStateChanged((user) => {
      const nameEl = document.getElementById("userName");
      if (user) {
        nameEl.textContent = user.displayName || "User";
      } else {
        window.location.href = "/auth/login.html";
      }
    });

    // mendeteksi lokasi user
    const locationSpan = document.getElementById("userLocation");

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;

          try {
            // Panggil API OpenStreetMap (Reverse Geocoding)
            const res = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
            );
            const data = await res.json();

            // Ambil nama kota & negara
            const city =
              data.address.city ||
              data.address.town ||
              data.address.village ||
              data.address.state ||
              "Tidak Diketahui";
            const country = data.address.country || "";

            locationSpan.textContent = `${city}, ${country}`;
          } catch (err) {
            locationSpan.textContent = "Gagal mendeteksi lokasi";
          }
        },
        (error) => {
          console.warn("Gagal mendeteksi lokasi:", error.message);
          locationSpan.textContent = "Lokasi tidak diizinkan";
        }
      );
    } else {
      locationSpan.textContent = "Geolocation tidak didukung";
    }

    // Ambil nama user dari Firebase Auth
    firebase.auth().onAuthStateChanged((user) => {
      const nameEl = document.getElementById("userName");
      const profileImg = document.getElementById("profileImage");
      const DEFAULT_PHOTO_URL = "/../assets/foto-default.jpeg";

      if (user) {
        // Tampilkan nama
        nameEl.textContent = user.displayName || user.email.split("@")[0];

        // 🔹 Foto profil otomatis
        profileImg.src = user.photoURL || DEFAULT_PHOTO_URL;
      } else {
        // Jika belum login
        window.location.href = "../auth/login.html";
      }
    });

    // Mendapatkan data cuaca berdasarkan lokasi user
    navigator.geolocation.getCurrentPosition(success, error);

    function success(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const apiKey = "7a93012ca85a13c3a2d47rabeeaef29dc4";

      console.log("Lokasi terdeteksi:", lat, lon);

      fetch(
        `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`
      )
        .then((res) => {
          if (!res.ok) throw new Error("HTTP error " + res.status);
          return res.json();
        })
        .then((data) => {
          console.log("Data cuaca:", data);
          const lokasi = data.name || "Tidak diketahui";
          const suhu = Math.round(data.main.temp);
          document.getElementById(
            "weatherInfo"
          ).innerHTML = `🌡️ Suhu di <strong>${lokasi}</strong>: <strong>${suhu}°C</strong>`;
        })
        .catch((err) => {
          console.error("Gagal ambil data:", err);
          document.getElementById("weatherInfo").textContent =
            "Gagal memuat suhu 😔";
        });
    }

    function error(err) {
      console.warn("Geolocation error:", err);
      document.getElementById("weatherInfo").textContent =
        "Tidak dapat mendeteksi lokasi 😔";
    }
  </script>
</html>
