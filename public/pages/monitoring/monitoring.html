<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitoring | Greenuity</title>
    <link rel="icon" type="image/png" href="/assets/logo/logo-greenuity.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { poppins: ["Poppins", "sans-serif"] },
            colors: {
              primary: "#1B4D57",
              "primary-light": "#2D6670",
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-gray-50 font-poppins pb-24">
    <!-- Hero Card -->
    <div class="relative mx-4 mt-6 font-[Poppins]">
      <!-- Card Putih -->
      <div class="bg-white rounded-t-3xl rounded-b-[2rem] shadow-lg p-6 pb-20">
        <div class="flex flex-col space-y-4">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <img
              src="../../assets/logo/logo-greenuity.svg"
              alt="Greenuity Logo"
              class="w-10 h-10"
            />
            <span class="text-[#157347] font-semibold text-lg">GREENUITY</span>
          </div>

          <!-- Judul dan deskripsi -->
          <div>
            <h2 class="text-xl font-bold text-gray-900 leading-snug mt-5">
              Solusi Cerdas Untuk
              <br />Pertanian Modern
            </h2>
            <p class="text-gray-500 text-[12px] mt-3 mb-5">
              Pantau Kebun, Tingkatkan Hasil.
            </p>
          </div>
        </div>
      </div>

      <!-- Bagian bawah (primary section) -->
      <div
        class="absolute bottom-0 left-0 right-0 bg-[#0E3B43] rounded-b-3xl flex justify-between items-center px-6 py-4 shadow-md"
      >
        <span class="text-white text-[15px] font-medium">Dapatkan Device</span>

        <button
          class="bg-white text-[#0E3B43] px-4 py-1.5 rounded-full font-medium flex items-center gap-2 shadow-sm hover:shadow-md transition"
        >
          <span class="text-sm">Dapatkan</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4 text-[#0E3B43]"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              fill-rule="evenodd"
              d="M18.403 5.633A8.92 8.92 0 0 0 12.053 3c-4.948 0-8.976 4.027-8.978 8.977 0 1.582.413 3.126 1.198 4.488L3 21.116l4.759-1.249a9 9 0 0 0 4.29 1.093h.004c4.947 0 8.975-4.027 8.977-8.977a8.93 8.93 0 0 0-2.627-6.35m-6.35 13.812h-.003a7.45 7.45 0 0 1-3.798-1.041l-.272-.162-2.824.741.753-2.753-.177-.282a7.45 7.45 0 0 1-1.141-3.971c.002-4.114 3.349-7.461 7.465-7.461a7.41 7.41 0 0 1 5.275 2.188 7.42 7.42 0 0 1 2.183 5.279c-.002 4.114-3.349 7.462-7.461 7.462m4.093-5.589c-.225-.113-1.327-.655-1.533-.73s-.354-.112-.504.112-.58.729-.711.879-.262.168-.486.056-.947-.349-1.804-1.113c-.667-.595-1.117-1.329-1.248-1.554s-.014-.346.099-.458c.101-.1.224-.262.336-.393s.149-.224.224-.374.038-.281-.019-.393c-.056-.113-.505-1.217-.692-1.666-.181-.435-.366-.377-.504-.383a10 10 0 0 0-.429-.008.83.83 0 0 0-.599.28c-.206.225-.785.767-.785 1.871s.804 2.171.916 2.321 1.582 2.415 3.832 3.387c.536.231.954.369 1.279.473.537.171 1.026.146 1.413.089.431-.064 1.327-.542 1.514-1.066s.187-.973.131-1.067-.207-.151-.43-.263"
              clip-rule="evenodd"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Device List Section -->
    <div class="px-6 mt-8">
      <h3 class="font-bold text-gray-900 text-lg mb-4">Device Kamu</h3>

      <!-- Legend -->
      <div class="flex items-center gap-4 mb-4">
        <div class="flex items-center gap-1.5">
          <span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>
          <span class="text-xs text-gray-600">Aktif</span>
        </div>
        <div class="flex items-center gap-1.5">
          <span class="w-2.5 h-2.5 bg-yellow-400 rounded-full"></span>
          <span class="text-xs text-gray-600">Maintenance</span>
        </div>
        <div class="flex items-center gap-1.5">
          <span class="w-2.5 h-2.5 bg-red-500 rounded-full"></span>
          <span class="text-xs text-gray-600">Non-aktif</span>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingDevices" class="text-center py-8">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mx-auto mb-4"
        ></div>
        <p class="text-gray-600 text-sm">Memuat perangkat...</p>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden text-center py-12">
        <div
          class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4"
        >
          <svg
            class="w-8 h-8 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
            />
          </svg>
        </div>
        <h3 class="text-base font-semibold text-gray-700 mb-2">
          Belum Ada Perangkat
        </h3>
        <p class="text-gray-500 text-sm mb-6">
          Tambahkan perangkat untuk mulai monitoring
        </p>
      </div>

      <!-- Device Cards -->
      <div id="deviceList" class="hidden space-y-3"></div>

      <!-- Add Device Button -->
      <button
        onclick="goToAddDevice()"
        class="w-full mt-4 bg-gray-100 text-gray-600 py-4 rounded-2xl flex items-center justify-center gap-2 hover:bg-gray-200 transition"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          />
        </svg>
        <span class="text-sm font-medium">Tambah device atau perangkat</span>
      </button>
    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-4 left-4 right-4 z-50">
      <div class="bg-white rounded-3xl shadow-2xl px-6 py-3">
        <div class="flex items-center justify-around">
          <button
            onclick="goToHome()"
            class="flex flex-col items-center space-y-1 text-gray-400 hover:text-gray-600 transition"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              />
            </svg>
            <span class="text-[10px]">Beranda</span>
          </button>

          <button class="flex flex-col items-center space-y-1 text-primary">
            <svg
              class="w-7 h-7"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
            <span class="text-[10px] font-semibold">Monitoring</span>
          </button>

          <button
            onclick="goToIrrigation()"
            class="flex flex-col items-center space-y-1 text-gray-400 hover:text-gray-600 transition"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
              />
            </svg>
            <span class="text-[10px]">Irigasi</span>
          </button>

          <button
            onclick="goToEducation()"
            class="flex flex-col items-center space-y-1 text-gray-400 hover:text-gray-600 transition"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              />
            </svg>
            <span class="text-[10px]">Edukasi</span>
          </button>

          <button
            onclick="goToProfile()"
            class="flex flex-col items-center space-y-1 text-gray-400 hover:text-gray-600 transition"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              />
            </svg>
            <span class="text-[10px]">Profil</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="/js/config/firebase-config.js"></script>

    <script>
      let currentUser = null;

      // Initialize
      window.addEventListener("DOMContentLoaded", () => {
        firebase.auth().onAuthStateChanged((user) => {
          if (!user) {
            window.location.href = "/auth/login.html";
          } else {
            currentUser = user;
            loadUserDevices();
          }
        });
      });

      // Load devices
      async function loadUserDevices() {
        try {
          const database = firebase.database();
          const userDevicesRef = database.ref(
            "users/" + currentUser.uid + "/devices"
          );

          userDevicesRef.on("value", async (snapshot) => {
            const deviceList = document.getElementById("deviceList");
            const loadingDevices = document.getElementById("loadingDevices");
            const emptyState = document.getElementById("emptyState");

            deviceList.innerHTML = "";

            if (!snapshot.exists()) {
              loadingDevices.classList.add("hidden");
              emptyState.classList.remove("hidden");
              deviceList.classList.add("hidden");
              return;
            }

            const deviceIds = Object.keys(snapshot.val());

            for (const deviceId of deviceIds) {
              const deviceSnapshot = await database
                .ref("devices/" + deviceId)
                .once("value");
              if (deviceSnapshot.exists()) {
                createDeviceCard(deviceId, deviceSnapshot.val());
              }
            }

            loadingDevices.classList.add("hidden");
            emptyState.classList.add("hidden");
            deviceList.classList.remove("hidden");

            // Real-time updates
            deviceIds.forEach((deviceId) => {
              database.ref("devices/" + deviceId).on("value", (snap) => {
                if (snap.exists()) {
                  updateDeviceCard(deviceId, snap.val());
                }
              });
            });
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Create device card (Simple Design)
      function createDeviceCard(deviceId, deviceData) {
        const deviceList = document.getElementById("deviceList");
        const info = deviceData.info || {};
        const current = deviceData.current || {};
        const status = info.status || "offline";

        let statusColor = "bg-red-500";
        if (status === "online") statusColor = "bg-green-500";
        else if (status === "configuring") statusColor = "bg-yellow-400";

        const plantEmojis = {
          cabai: "ðŸŒ¶ï¸",
          tomat: "ðŸ…",
          terong: "ðŸ†",
          sawi: "ðŸ¥¬",
          kangkung: "ðŸ¥¬",
          bayam: "ðŸ¥¬",
          selada: "ðŸ¥—",
          timun: "ðŸ¥’",
          jagung: "ðŸŒ½",
          padi: "ðŸŒ¾",
          lainnya: "ðŸŒ±",
        };
        const plantName = info.jenis_tanaman
          ? info.jenis_tanaman.charAt(0).toUpperCase() +
            info.jenis_tanaman.slice(1)
          : "Lahan";

        const card = document.createElement("button");
        card.id = "device-" + deviceId;
        card.className =
          "w-full bg-white rounded-2xl shadow-sm hover:shadow-md transition-all p-4 text-left";
        card.onclick = () => goToDeviceDetail(deviceId);

        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="text-2xl">${
                plantEmojis[info.jenis_tanaman] || "ðŸŒ±"
              }</div>
              <div>
                <h4 class="font-semibold text-gray-900 text-sm">${
                  info.nama_lahan || "Kebun " + plantName
                }</h4>
                <p class="text-xs text-gray-500">Ketuk untuk melihat detail</p>
              </div>
            </div>
            <span class="${statusColor} w-3 h-3 rounded-full" id="status-${deviceId}"></span>
          </div>
        `;

        deviceList.appendChild(card);
      }

      // Update device card
      function updateDeviceCard(deviceId, deviceData) {
        const statusDot = document.getElementById("status-" + deviceId);
        if (statusDot) {
          const status = deviceData.info?.status || "offline";
          let statusColor = "bg-red-500";
          if (status === "online") statusColor = "bg-green-500";
          else if (status === "configuring") statusColor = "bg-yellow-400";

          statusDot.className = `${statusColor} w-3 h-3 rounded-full`;
        }
      }

      // ðŸ”¹ Deteksi Device Tidak Aktif (mati diam-diam)
      function checkDeviceActivity(deviceId, deviceData) {
        const lastSeen = deviceData.info?.last_seen || 0;
        const now = Date.now();
        const diffMinutes = Math.floor((now - lastSeen) / 60000); // dalam menit

        const statusDot = document.getElementById("status-" + deviceId);

        if (!statusDot) return;

        // Kalau device terakhir aktif lebih dari 2 menit, anggap offline
        if (diffMinutes > 2) {
          statusDot.className = "bg-red-500 w-3 h-3 rounded-full";
        }
      }

      // ðŸ”¸ Jalankan pengecekan tiap 30 detik untuk semua device
      setInterval(() => {
        const database = firebase.database();
        const userDevicesRef = database.ref(
          "users/" + currentUser.uid + "/devices"
        );

        userDevicesRef.once("value", (snapshot) => {
          if (!snapshot.exists()) return;
          const deviceIds = Object.keys(snapshot.val());

          deviceIds.forEach((deviceId) => {
            database.ref("devices/" + deviceId).once("value", (snap) => {
              if (snap.exists()) checkDeviceActivity(deviceId, snap.val());
            });
          });
        });
      }, 30000);

      // Navigation
      function goToHome() {
        window.location.href = "/pages/dashboard/dashboard.html";
      }

      function goToIrrigation() {
        window.location.href = "../irrigation/irrigation.html";
      }

      function goToEducation() {
        window.location.href = "../edukasi/edukasi.html";
      }

      function goToProfile() {
        window.location.href = "../profile/profile.html";
      }

      function goToAddDevice() {
        window.location.href = "add-device.html";
      }

      function goToDeviceDetail(deviceId) {
        window.location.href = `info-sensor.html?deviceId=${deviceId}`;
      }
    </script>
  </body>
</html>
